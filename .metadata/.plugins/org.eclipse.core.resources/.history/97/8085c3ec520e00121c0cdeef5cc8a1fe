package vis.db

import groovy.sql.Sql

import java.sql.Connection
import java.sql.PreparedStatement
import java.sql.ResultSet

class VisualFeatures {
	Connection con;
	PreparedStatement stmt;
	
	Sql sql
	Map featureCache = [:]
	
	public VisualFeatures(){
		init()
	}
	
	private void init(){
		// do database connection
		con = ConnectionFactory.getByName("features")
		sql = Sql.newInstance(db.url, db.user, db.password, db.driver)
		
		// select statement
		stmt = con.prepareStatement("select fotolia_id, feature_vectors from image where fotolia_id=? limit 1");
	}	
	
	public byte[] getFeature(Integer fotoliaId){
		byte[] features;
		
		// set params
		stmt.setInt(1, fotoliaId);
		ResultSet rs = stmt.executeQuery();
		while(rs.next()){
			features = rs.getArray(2);
		}
		
		
		def cached = featureCache[fotoliaId]
		if(cached)return cached
		
		int[] features = null 
		sql.rows("").each{ row ->
			features = row['feature_vectors']					
		}
		featureCache[fotoliaId] = features		
		return features;
	}
	
	public void shutdown(){
		con.close();
	}

	static main(args) {
		def f = new VisualFeatures()
		100.times{
			println f.getFeature(20)
		}
	}

}
