package vis.db

import groovy.sql.Sql

import java.sql.Connection

class VisualFeatures {
	Connection con;
	Sql sql
	Map featureCache = [:]
	
	public VisualFeatures(){
		init()
	}
	
	private void init(){
		// do database connection
		con = ConnectionFactory.getByName("features")
		sql = Sql.newInstance(db.url, db.user, db.password, db.driver)
		
	}	
	
	public byte[] getFeature(Integer fotoliaId){
		def cached = featureCache[fotoliaId]
		if(cached)return cached
		
		int[] features = null 
		sql.rows("select fotolia_id, feature_vectors from image where fotolia_id=$fotoliaId limit 1").each{ row ->
			features = row['feature_vectors']					
		}
		featureCache[fotoliaId] = features		
		return features;
	}
	
	public void shutdown(){
		con.close();
	}

	static main(args) {
		def f = new VisualFeatures()
		100.times{
			println f.getFeature(20)
		}
	}

}
